# Pact JVM example (Maven + Springboot + JUnit5)

### Table of contents

- [Purpose of this project](#purpose-of-this-project)
- [Generate Pacts](#generate-pacts)
- [Publish Pacts](#publish-pacts)
    - [Publish Pacts in localhost](#publish-pacts-in-localhost)
    - [Publish Pacts in the Pact Broker](#publish-pacts-in-the-pact-broker)
    - [Publish Pacts in the Pactflow.io](#publish-pacts-in-the-pactflowio)
- [Verify Pacts](#verify-pacts)
    - [Verify Pacts in localhost](#verify-pacts-in-localhost)
    - [Verify Pacts in the Pact Broker](#verify-pacts-in-the-pact-broker)
    - [Verify Pacts in the Pactflow.io](#verify-pacts-in-the-pactflowio)
- [Can I deploy](#can-i-deploy)
- [Reference](#references)

## Purpose of this project

The aim of this project is to see how to configure 2 microservices, a provider and a consumer (both REST API Spring
Boot), to run contract testing with Pact using PactBroker to publish/verify contracts generated.

## Generate Pacts

To generate pacts for a specific contract file

```bash
mvn -Dtest=ConsumerContractTest verify -pl Consumer
 ```

To generate pacts for all contract tests files

````bash
mvn verify -pl Consumer
````

## Publish Pacts

### Publish Pacts in localhost

You only need to copy the pact generated locally by consumer (`Consumer/target/pacts` is the default folder) into the
provider pacts folder

### Publish Pacts in the Pact Broker

First you need to generate the pacts as it is mentioned in the step before

Then, you need to configure the `pom.xml` file on the Consumer side as below:

```xml
<build>
    <plugins>
        <plugin>
            <groupId>au.com.dius.pact.provider</groupId>
            <artifactId>maven</artifactId>
            <version>${pact.version}</version>
            <configuration>
                <pactBrokerUrl>http://localhost:9292</pactBrokerUrl>
                <pactBrokerUsername>pact_workshop</pactBrokerUsername>
                <pactBrokerPassword>pact_workshop</pactBrokerPassword>
                <tags>
                    <tag>prod</tag>
                    <tag>test</tag>
                </tags>
            </configuration>
        </plugin>
    </plugins>
</build>
```

After that, you can run the following command to publish the pacts:

```bash
docker-compose up -d # To initialize the Pact Broker
mvn pact:publish -pl Consumer
```

### Publish Pacts in the PactFlow.io

First, you need to generate the pacts as it is mentioned in the step before.

Then, you need to get an account in [Pactflow.io](https://pactflow.io/sign-in/) (this account will be
the `<pactBrokerUrl>` property) and get the `API_TOKEN_PACTFLOW` in the settings page of your profile.

Finally, you need to configure the `pom.xml` file on the Consumer side with the previous data obtained as below:

```xml
<build>
    <plugins>
        <plugin>
            <groupId>au.com.dius.pact.provider</groupId>
            <artifactId>maven</artifactId>
            <version>${pact.version}</version>
            <configuration>
                <pactBrokerUrl>PACTFLOW_URL</pactBrokerUrl>
                <pactBrokerToken>API_TOKEN_PACTFLOW</pactBrokerToken>
                <tags>
                    <tag>prod</tag>
                    <tag>test</tag>
                </tags>
            </configuration>
        </plugin>
    </plugins>
</build>
```

After that, you can run the following command to publish the pacts:

```bash
mvn pact:publish -pl Consumer
```

## Verify Pacts

### Verify Pacts in localhost

To verify pacts for a specific file

```bash
mvn -Dtest=ProviderContractTest verify -pl Provider
```

To verify pacts generated by the consumer side

```bash
mvn verify -pl Provider
```

### Verify Pacts in the Pact Broker

You need to configure the data of the Pact Broker in the `Provider/src/test/resources/application.yml`

```yml
pactbroker:
  host: localhost
  port: "9292"
  auth:
    username: pact_workshop
    password: pact_workshop
```

To verify pacts and publish the results in the Pact Broker (which has the Pact published previously by the Consumer)

```bash
mvn verify -Dpact.verifier.publishResults=true -Dpact.provider.version=0.0.1-SNAPSHOT -pl Provider
```

### Verify Pacts in the Pactflow.io

You need to configure the data of the Pactflow in the `Provider/src/test/resources/application.yml`

```yml
pactbroker:
  host: <PACTFLOW_URL>
  scheme: https
  auth:
    token: <API_TOKEN_PACTFLOW>
```

To verify pacts and publish the results in the Pactflow (which has the Pact published previously by the Consumer)

```bash
mvn verify -Dpact.verifier.publishResults=true -Dpact.provider.version=0.0.1-SNAPSHOT -pl Provider
```

## Can I Deploy

We can use Pact Broker can-i-deploy tool to determine if a consumer o provider is safe to release to the specified
environment.

We need to include in the Provider/pom.xml the following plugin:

```xml
<build>
    <plugins>
        <plugin>
            <groupId>au.com.dius.pact.provider</groupId>
            <artifactId>maven</artifactId>
            <version>${pact.version}</version>
            <configuration>
                <pactBrokerUrl>http://localhost:9292</pactBrokerUrl>
                <pactBrokerUsername>pact_workshop</pactBrokerUsername>
                <pactBrokerPassword>pact_workshop</pactBrokerPassword>
            </configuration>
        </plugin>
    </plugins>
</build>
```

And now, we can run the can-i-deploy checks as follows:

```bash
mvn pact:can-i-deploy -Dpacticipant='Student' -Dlatest=true -pl Consumer

[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------< com.example:Consumer >------------------------
[INFO] Building Consumer 0.0.1-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- maven:4.2.10:can-i-deploy (default-cli) @ Consumer ---
Computer says yes \o/ 

WARN: For production use of can-i-deploy, it is recommended to specify the environment into which you are deploying. Without the environment, this result will not be reliable.
WARN: For production use of can-i-deploy, it is recommended to specify the version number (rather than latest tag or branch) of each pacticipant to avoid race conditions.
All required verification results are published and successful
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------

-----------------

mvn pact:can-i-deploy -Dpacticipant='Provider' -Dlatest=true -pl Provider

[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------< com.example:Provider >------------------------
[INFO] Building Provider 0.0.1-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- maven:4.2.10:can-i-deploy (default-cli) @ Provider ---
Computer says yes \o/ 

WARN: For production use of can-i-deploy, it is recommended to specify the environment into which you are deploying. Without the environment, this result will not be reliable.
WARN: For production use of can-i-deploy, it is recommended to specify the version number (rather than latest tag or branch) of each pacticipant to avoid race conditions.
All required verification results are published and successful
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
```

**To take into account:**

---
When we want to verify the pact generated by consumer, we have two possibilities:

1. Copy pact generated locally by consumer in the provider pacts folder
2. Publish the pact generated by consumer into the Pact Broker and download the pact from it. To do that:
    1. For the consumer side run the following command:
       ```bash
       docker-compose up -d # To initialize the Pact Broker
       mvn pact:publish -pl Consumer
       ```
    2. For the provider side:
        1. In the ProviderContractTest.java uncomment `@PactBroker` command and comment `@PactFolder` command
           ```java   
           @PactBroker
           //@PactFolder("src/pacts") 
           ```
        2. Run the following command:
            ```bash
            mvn verify -Dpact.verifier.publishResults=true -Dpact.provider.version=0.0.1-SNAPSHOT -pl Provider
            ```
---

## References

- [Pact Workshop Maven + Springboot + JUnit5](https://github.com/pact-foundation/pact-workshop-Maven-Springboot-JUnit5)
- [Example Spring Boot project for the Pact workshop](https://github.com/pact-foundation/pact-workshop-jvm-spring)
- [Consumer Driven Contract Testing using pact java](https://blog.testproject.io/2020/05/27/consumer-driven-contract-testing-using-pact-java)
